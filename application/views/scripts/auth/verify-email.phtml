<?php 
    // Zend_Debug::dump($this->result['participants']);die;
?><style>
    td {
        padding: 5px !important;
    }

    th {
        text-align: right;
    }
</style>
<div class="box">
    <div class="box-body">

        <h2 class="txt text-info" style="text-align: center;">Reset My Primary email</h2>

        <form id="resetEmail" name="resetEmail" method="post" action="/auth/verify-email">
            <br>
            <table cellpadding="0" cellspacing="0" border="0" class="table table-striped table-bordered table-hover text-center">
                <thead>
                    <tr align="center">
                        <th>Participant ID</th>
                        <th>Name</th>
                        <th>Institute Name</th>
                        <th>Region</th>
                        <th>Country</th>
                    </tr>
                </thead>
                <tbody>
                    <?php foreach($this->result['participants'] as $participant){?>
                        <tr>
                            <td><?php echo $participant['unique_identifier'];?></td>
                            <td><?php echo $participant['first_name']. ' ' .$participant['last_name'];?></td>
                            <td><?php echo $participant['institute_name'];?></td>
                            <td><?php echo $participant['state'];?></td>
                            <td><?php echo $participant['iso_name'];?></td>
                        </tr>
                    <?php }?>
                </tbody>
            </table>
            <br>
            <hr>
            <table style="width: 60%;margin: auto;">
                <tr>
                    <th style="width:270px;">
                        <label for="registeredEmail" class="uname" data-icon="u">Please enter valid email id</label>
                    </th>
                    <td>
                        <input type="hidden" value="<?php echo (isset($this->result['email']) && $this->result['email'] != "")?$this->result['email']:"";?>" id="oldEmail" name="oldEmail"/>
                        <input type="hidden" value="<?php echo (isset($this->result['id']) && $this->result['id'] != "")?base64_encode($this->result['id']):"";?>" id="dmId" name="dmId"/>
                        <input value="<?php echo (isset($this->result['email']) && $this->result['email'] != "")?$this->result['email']:"";?>" id="registeredEmail" name="registeredEmail" class="isRequired form-control" title="Please enter your valid email" type="text" placeholder="mymail@mail.com" />
                    </td>
                </tr>
                <tr>
                    <th style="width:270px;">
                        <label for="confirmMail" class="uname" data-icon="u">Confirm your email id</label>
                    </th>
                    <td>
                        <input id="confirmMail" name="confirmMail" class="isRequired form-control" title="Please enter your confirm email" type="text" placeholder="mymail@mail.com" />
                    </td>
                </tr>
                <tr>
                    <td colspan="2">
                        <table border="0" style="width:50%;margin-top: 10px;margin:0 auto;clear: both;">
                            <tbody>
                                <tr>
                                    <td>
                                        <div style="float:left;margin:5px;">
                                            <img id="capChaw" src="/captcha/<?php echo rand(); ?>" />
                                        </div>
                                    </td>
                                    <td style="padding-top:3px;" align="center">
                                        <input type="text" style="margin:0;width:200px;padding:3px;margin-top:8px" id="challengeResponse" placeholder="Enter text from image on left" class="isRequired form-control" title="Please enter the text from the image." maxlength="40">
                                        <a onclick="getCaptcha('capChaw');return false;" style="cursor:pointer;font-size:12px;margin:5px;"><i class="icon-refresh icon-white"></i> Get New Image</a>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td colspan="2" align="center">
                        <button class="btn btn-primary" onclick="validateEmail();return false;">Submit</button>
                    </td>
                </tr>

            </table>
        </form>
    </div>
</div>
<script type="text/javascript" src="<?php echo $this->baseUrl("js/jquery.blockUI.js"); ?>"></script>
<script type="text/javascript" src="<?php echo $this->baseUrl("js/deforayValidation.js"); ?>"></script>
<script type="text/javascript">
    $("#tableCss").remove();

    function getCaptcha(captchaDivId) {
        $.blockUI();
        var d = new Date();
        var randstr = 'r-' + d.getFullYear() + d.getSeconds() + d.getMilliseconds() + Math.random();
        $("#" + captchaDivId).attr("src", '/captcha/' + randstr);
        $("#" + captchaDivId).load(function() {
            $.unblockUI();
        });
    }

    function validateEmail() {
        if($('#registeredEmail').val() == $('#confirmMail').val()){

            flag = deforayValidator.init({
                formId: 'resetEmail'
            });
            if (flag) {
                challenge_field = document.getElementById("challengeResponse").value;
                if (challenge_field != "") {
                    $.post("<?php echo $this->url(array(), 'checkCaptchaRoute', true); ?>", {
                            challenge_field: challenge_field,
                            format: "html"
                        },
                        function(data) {
                            if (data == 'fail') {
                                alert("Text you entered from the image is incorrect. Please try again");
                                getCaptcha('capChaw');
                                document.getElementById("challengeResponse").value = "";
                                return false;
                            } else {
                                $.blockUI();
                                document.getElementById('resetEmail').submit();
                            }
                        });
                } else {
                    alert("Please enter the text from the image to proceed.");
                }
            }
        }else{
            alert('Please make sure email and confirm email are same.');
        }
    }
</script>