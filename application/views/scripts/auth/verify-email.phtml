<?php 
    // Zend_Debug::dump($this->result['participants']);die;
?><style>
    td {
        padding: 5px !important;
    }

    th {
        text-align: right;
    }
    @media screen and (max-width: 992px) {
        .captcha{
            margin-top: 0px !important;
        }
        .padding-div{
            padding: 0px 30px 0px 30px;
        }
        .control-label, .captcha{
            float: left;
        }
    }
</style>
<div class="box">
    <div class="box-body">

        <h2 class="txt text-info" style="text-align: center;">Reset ePT Login email</h2>

        <form id="resetEmail" name="resetEmail" method="post" action="/auth/verify-email">
            <br>
            <div class="table-responsive">
                <table cellpadding="0" cellspacing="0" border="0" class="table table-striped table-bordered table-hover text-center">
                    <thead>
                        <tr align="center">
                            <th>Participant ID</th>
                            <th>Name</th>
                            <th>Institute Name</th>
                            <th>Region</th>
                            <th>Country</th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php foreach($this->result['participants'] as $participant){?>
                            <tr>
                                <td><?php echo $participant['unique_identifier'];?></td>
                                <td><?php echo $participant['first_name']. ' ' .$participant['last_name'];?></td>
                                <td><?php echo $participant['institute_name'];?></td>
                                <td><?php echo $participant['state'];?></td>
                                <td><?php echo $participant['iso_name'];?></td>
                            </tr>
                        <?php }?>
                    </tbody>
                </table>
            </div>
            <br>
            <hr>
            <div class="text-center" style="margin: auto;display:block;">
                <fieldset class="form-set">
                    <div class="form-group row text-center">
                        <label class="col-lg-3 control-label" for="registeredEmail">Please enter valid email id <span class="mandatory">*</span></label>
                        <div class="col-lg-3 col-md-5 col-sm-6 padding-div">
                            <input type="hidden" value="<?php echo (isset($this->result['email']) && $this->result['email'] != "")?$this->result['email']:"";?>" id="oldEmail" name="oldEmail"/>
                            <input type="hidden" value="<?php echo (isset($this->result['id']) && $this->result['id'] != "")?base64_encode($this->result['id']):"";?>" id="dmId" name="dmId"/>
                            <input value="<?php echo (isset($this->result['email']) && $this->result['email'] != "")?$this->result['email']:"";?>" id="registeredEmail" name="registeredEmail" class="isRequired form-control" title="Please enter your valid email" type="text" placeholder="mymail@mail.com" />
                        </div>
                    </div>
                   
                    <div class="form-group text-center">
                        <label class="col-lg-3 control-label">Confirm your email id <span class="mandatory">*</span></label>
                        <div class="col-lg-3 col-md-5 col-sm-6">
                            <input id="confirmMail" name="confirmMail" class="isRequired form-control" title="Please enter your confirm email" type="text" placeholder="mymail@mail.com" />
                        </div>
                    </div>
                    <div class="form-group text-center">
                        <img class="col-lg-3 captcha" id="capChaw" src="/captcha/<?php echo rand(); ?>" style="margin-top: -50px;height: 85px;"/>
                        <div class="col-lg-3 col-md-5 col-sm-6 captcha" style="margin-top: -30px;">
                            <input type="text" style="margin:0;width:100%;padding:3px;margin-top:8px" id="challengeResponse" placeholder="Enter text from image on left" class="isRequired form-control" title="Please enter the text from the image." maxlength="40">
                            <a onclick="getCaptcha('capChaw');return false;" style="cursor:pointer;font-size:12px;margin:5px;"><i class="icon-refresh icon-white"></i> Get New Image</a>
                        </div>
                    </div>
                    <br>
                    <div class="form-group row" style="margin-top: 30px;">
                        <div id="respond" style="margin: 0px auto 0px auto; text-align: center;" align="center">
                            <button class="btn btn-primary" onclick="validateEmail();return false;">Save email</button>
                        </div>
                    </div>
                </fieldset>
            </div>
        </form>
    </div>
</div>
<script type="text/javascript" src="<?php echo $this->baseUrl("js/jquery.blockUI.js"); ?>"></script>
<script type="text/javascript" src="<?php echo $this->baseUrl("js/deforayValidation.js"); ?>"></script>
<script type="text/javascript">
    $("#tableCss").remove();

    function getCaptcha(captchaDivId) {
        $.blockUI();
        var d = new Date();
        var randstr = 'r-' + d.getFullYear() + d.getSeconds() + d.getMilliseconds() + Math.random();
        $("#" + captchaDivId).attr("src", '/captcha/' + randstr);
        $("#" + captchaDivId).load(function() {
            $.unblockUI();
        });
    }

    function validateEmail() {
        if($('#registeredEmail').val() == $('#confirmMail').val()){

            flag = deforayValidator.init({
                formId: 'resetEmail'
            });
            if (flag) {
                challenge_field = document.getElementById("challengeResponse").value;
                if (challenge_field != "") {
                    $.post("<?php echo $this->url(array(), 'checkCaptchaRoute', true); ?>", {
                            challenge_field: challenge_field,
                            format: "html"
                        },
                        function(data) {
                            if (data == 'fail') {
                                alert("Text you entered from the image is incorrect. Please try again");
                                getCaptcha('capChaw');
                                document.getElementById("challengeResponse").value = "";
                                return false;
                            } else {
                                $.blockUI();
                                document.getElementById('resetEmail').submit();
                            }
                        });
                } else {
                    alert("Please enter the text from the image to proceed.");
                }
            }
        }else{
            alert('Please make sure email and confirm email are same.');
        }
    }
</script>